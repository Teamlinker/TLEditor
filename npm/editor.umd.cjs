(function(D,p){typeof exports=="object"&&typeof module<"u"?p(exports,require("vue")):typeof define=="function"&&define.amd?define(["exports","vue"],p):(D=typeof globalThis<"u"?globalThis:D||self,p(D.editor={},D.Vue))})(this,function(D,p){"use strict";var pe=Object.defineProperty;var fe=(D,p,E)=>p in D?pe(D,p,{enumerable:!0,configurable:!0,writable:!0,value:E}):D[p]=E;var M=(D,p,E)=>(fe(D,typeof p!="symbol"?p+"":p,E),E);var E=(x=>(x[x.TEXT=0]="TEXT",x[x.LINK=1]="LINK",x[x.IMAGE=2]="IMAGE",x))(E||{});class T{static handle(l,i){let a="";for(let e of l.arr){let n;if(e.type==E.TEXT)if(e.style&&Object.keys(e.style).length>0){if(n=document.createElement("span"),n.innerText=e.value,e.style)for(let t in e.style)n.style[t]=e.style[t]}else{a+=e.value;continue}else e.type==E.LINK?n=document.createElement("a"):e.type==E.IMAGE?n=document.createElement("img"):n=document.createElement("a"),i==null||i(n,e);n&&(a+=n.outerHTML)}return a}static handleInnerHtml(l,i,a=!1,e){l.selectEndIndexPath=[],l.selectStartIndexPath=[],l.arr=[],i.childNodes.forEach(d=>{var u,m,c,f,y,w,b,k;if(d.nodeType==Node.TEXT_NODE){let O={value:d.nodeValue,style:{},type:E.TEXT};l.arr.push(O)}else if(d.nodeType==Node.ELEMENT_NODE){let O={value:"",style:{}},P=d;P.tagName=="SPAN"?(O.type=E.TEXT,O.value=P.innerText??""):e==null||e(O,P),(u=P.style)!=null&&u.color&&(O.style.color=(m=P.style)==null?void 0:m.color),(c=P.style)!=null&&c.fontStyle&&(O.style.fontStyle=P.style.fontStyle),(f=P.style)!=null&&f.fontWeight&&(O.style.fontWeight=P.style.fontWeight),(y=P.style)!=null&&y.fontSize&&(O.style.fontSize=P.style.fontSize),(w=P.style)!=null&&w.backgroundColor&&(O.style.backgroundColor=(b=P.style)==null?void 0:b.backgroundColor),(k=P.style)!=null&&k.textDecoration&&(O.style.textDecoration=P.style.textDecoration),l.arr.push(O)}});let n=window.getSelection(),t;n.rangeCount>0?t=n.getRangeAt(0):(t=document.createRange(),t.selectNodeContents(i),t.collapse(!1));let s=t.startOffset,r=t.endOffset,o=t.startContainer,h=t.endContainer;if(i.contains(o))if(i==o)o.childNodes.length==0||s>=o.childNodes.length?l.selectStartIndexPath=[s>0?s-1:0,o.childNodes.length==0?0:o.lastChild.textContent?o.lastChild.textContent.length:0]:l.selectStartIndexPath=[s,0];else{l.selectStartIndexPath.unshift(s);let d=o.parentElement;d==i?(s=Array.from(d.childNodes).indexOf(o),l.selectStartIndexPath.unshift(s)):(s=Array.from(d.parentElement.childNodes).indexOf(d),l.selectStartIndexPath.unshift(s))}if(i.contains(h))if(i==h)h.childNodes.length==0||r>=h.childNodes.length?l.selectEndIndexPath=[r>0?r-1:0,h.childNodes.length==0?0:h.lastChild.textContent?h.lastChild.textContent.length:0]:l.selectEndIndexPath=[r,0];else{l.selectEndIndexPath.unshift(r);let d=h.parentElement;d==i?(r=Array.from(d.childNodes).indexOf(h),l.selectEndIndexPath.unshift(r)):(r=Array.from(d.parentElement.childNodes).indexOf(d),l.selectEndIndexPath.unshift(r))}if(a){for(;o.tagName!=="DIV";)o=o.parentElement;for(;h.tagName!=="DIV";)h=h.parentElement;p.nextTick(()=>{if(o==i){let d=o.childNodes[l.selectStartIndexPath[0]];if(!d)return;if(d.nodeType==Node.TEXT_NODE)t.setStart(d,l.selectStartIndexPath[1]);else if(d.nodeType==Node.ELEMENT_NODE)if(d.tagName=="BR"){t.selectNode(d);return}else if(d.tagName=="IMG"){t.selectNode(d),t.collapse(!1);return}else d.contentEditable=="true"&&t.setStart(d.firstChild,l.selectStartIndexPath[1])}if(h==i){let d=h.childNodes[l.selectEndIndexPath[0]];if(!d)return;if(d.nodeType==Node.TEXT_NODE)t.setEnd(d,l.selectEndIndexPath[1]);else if(d.nodeType==Node.ELEMENT_NODE)if(d.tagName=="BR"||d.tagName=="IMG"){t.selectNode(d);return}else d.contentEditable==="true"&&t.setEnd(d.firstChild,l.selectEndIndexPath[1])}})}}static fixLine(l,i){for(let a=1;a<l.arr.length;a++){let e=l.arr[a],n=l.arr[a-1];if(e.style&&n.style&&JSON.stringify(e.style)===JSON.stringify(n.style)&&e.type==n.type&&e.type==E.TEXT||!e.value&&e.type!=E.IMAGE){let t=n.value.length;n.value+=e.value,l.arr.splice(a,1),a--,i&&(p.toRaw(i.startItem)===p.toRaw(e)&&(i.startItem=n,i.startIndex+=t),p.toRaw(i.endItem)===p.toRaw(e)&&(i.endItem=n,i.endIndex+=t))}}for(let a=0;a<l.arr.length;a++){let e=l.arr[a];!e.value&&e.type!=E.IMAGE&&(l.arr.splice(a,1),a--)}}}function U(x,l){let i=x.getLineList(),a=x.getRoot(),e=x.getSelectElementList();if(e.length==1){let n=i[Array.from(a.value.children).indexOf(e[0])];if(n.selectStartIndexPath.length>0&&n.selectEndIndexPath.length>0){let t;if(n.selectEndIndexPath[0]>n.selectStartIndexPath[0]){let s=n.arr[n.selectStartIndexPath[0]],r=n.arr[n.selectEndIndexPath[0]],o;for(let d=n.selectStartIndexPath[0];d<=n.selectEndIndexPath[0];d++){let u=n.arr[d];u==s?n.selectStartIndexPath[1]>0&&u.link!=l?(o={style:{...u.style},value:u.value.substring(n.selectStartIndexPath[1]),type:E.LINK,link:l},u.value=u.value.substring(0,n.selectStartIndexPath[1]),n.arr.splice(d+1,0,o),d++,n.selectEndIndexPath[0]++,s=o):(u.link=l,u.type=E.LINK,s=u):u==r?(s.value+=u.value.substring(0,n.selectEndIndexPath[1]),u.value=u.value.substring(n.selectEndIndexPath[1])):(s.value+=u.value,n.arr.splice(d,1),d--,n.selectEndIndexPath[0]--)}let h={startItem:s};T.fixLine(n,h),p.nextTick(()=>{let d=window.getSelection(),u=document.createRange(),m=e[0].childNodes[n.arr.indexOf(h.startItem)];u.selectNode(m),d.removeAllRanges(),d.addRange(u)})}else{let s=n.arr[n.selectStartIndexPath[0]];if(!s)return;let r,o=s.value.substring(n.selectStartIndexPath[1],n.selectEndIndexPath[1]),h=s.value.substring(0,n.selectStartIndexPath[1]),d=s.value.substring(n.selectEndIndexPath[1]);s.value=h,t={value:o,style:{...s.style},type:E.LINK,link:l},n.arr.splice(n.selectStartIndexPath[0]+1,0,t,{value:d,style:{...s.style},type:s.type,...s.link&&{link:s.link}}),T.fixLine(n),r=t,p.nextTick(()=>{let u=window.getSelection(),m=document.createRange(),c=e[0].childNodes[n.arr.indexOf(r)];c&&(m.selectNode(c),u.removeAllRanges(),u.addRange(m))})}}}}function Q(x,l,i){let a=x.getLineList(),e=x.getRoot(),n=x.getSelectElementList();if(n.length==1){let t=a[Array.from(e.value.children).indexOf(n[0])];if(T.handleInnerHtml(t,e.value.children[a.indexOf(t)],!1,x.onGetLineConfigType),t.arr.length==0){let s={type:E.IMAGE,link:l,value:"",width:i};t.arr.push(s)}else{let s=t.arr[t.selectStartIndexPath[0]],r={type:E.IMAGE,value:"",link:l,width:i},o=JSON.parse(JSON.stringify(s));o.type==E.IMAGE?t.arr.splice(t.selectStartIndexPath[0]+1,0,r):(o.value=o.value.substring(t.selectStartIndexPath[1]),s.value=s.value.substring(0,t.selectStartIndexPath[1]),t.arr.splice(t.selectStartIndexPath[0]+1,0,r,o))}}}function j(x,l,i){let a=x.getLineList(),e=x.getRoot(),n=x.getSelectElementList();if(n.length==1){let t=a[Array.from(e.value.children).indexOf(n[0])];if(t.selectStartIndexPath.length>0&&t.selectEndIndexPath.length>0){let s;if(t.selectEndIndexPath[0]>t.selectStartIndexPath[0]){let r=t.arr[t.selectStartIndexPath[0]],o=t.arr[t.selectEndIndexPath[0]],h,d;for(let m=t.selectStartIndexPath[0];m<=t.selectEndIndexPath[0];m++){let c=t.arr[m];if(c==r)if(t.selectStartIndexPath[1]>0&&c.style[l]!=i){let f;if(i)f={style:Object.assign({},c.style,{[l]:i}),value:c.value.substring(t.selectStartIndexPath[1]),type:E.TEXT};else{let y={...c.style};delete y[l],f={style:y,value:c.value.substring(t.selectStartIndexPath[1]),type:E.TEXT}}c.value=c.value.substring(0,t.selectStartIndexPath[1]),t.arr.splice(m+1,0,f),m++,t.selectEndIndexPath[0]++,r=f,h=0}else i?Object.assign(c.style,c.style,{[l]:i}):delete c.style[l],r=c,h=t.selectStartIndexPath[1];else if(c==o)if(t.selectEndIndexPath[1]<c.value.length&&c.style[l]!=i){let f;if(i)f={style:Object.assign({},c.style,{[l]:i}),value:c.value.substring(0,t.selectEndIndexPath[1]),type:E.TEXT};else{let y={...c.style};delete y[l],f={style:y,value:c.value.substring(0,t.selectEndIndexPath[1]),type:E.TEXT}}c.value=c.value.substring(t.selectEndIndexPath[1]),t.arr.splice(m,0,f),m++,t.selectEndIndexPath[0]++,o=f,d=f.value.length}else i?Object.assign(c.style,c.style,{[l]:i}):delete c.style[l],o=c,d=t.selectEndIndexPath[1];else i?Object.assign(c.style,c.style,{[l]:i}):delete c.style[l]}let u={startItem:r,endItem:o,startIndex:h,endIndex:d};T.fixLine(t,u),p.nextTick(()=>{let m=window.getSelection(),c=document.createRange(),f=n[0].childNodes[t.arr.indexOf(u.startItem)],y=n[0].childNodes[t.arr.indexOf(u.endItem)];f.nodeType==Node.TEXT_NODE?c.setStart(f,u.startIndex):f.nodeType==Node.ELEMENT_NODE&&(f.tagName=="IMG"?c.setStartBefore(f):c.setStart(f.firstChild,u.startIndex)),y.nodeType==Node.TEXT_NODE?c.setEnd(y,u.endIndex):y.nodeType==Node.ELEMENT_NODE&&(y.tagName=="IMG"?c.setEndAfter(y):c.setEnd(y.firstChild,u.endIndex)),m.removeAllRanges(),m.addRange(c)})}else{let r=t.arr[t.selectStartIndexPath[0]];if(!r)return;let o,h,d;if(r.style[l]!=i){let u=r.value.substring(t.selectStartIndexPath[1],t.selectEndIndexPath[1]),m=r.value.substring(0,t.selectStartIndexPath[1]),c=r.value.substring(t.selectEndIndexPath[1]);if(r.value=m,i)s=JSON.parse(JSON.stringify(r)),s.value=u,s.style=Object.assign({},r.style,{[l]:i});else{s=JSON.parse(JSON.stringify(r));let f={...r.style};delete f[l],s.value=u,s.style=f}t.arr.splice(t.selectStartIndexPath[0]+1,0,s,{value:c,style:{...r.style},type:E.TEXT}),T.fixLine(t),o=0,h=s.value.length,d=s}else d=r,o=t.selectStartIndexPath[1],h=t.selectEndIndexPath[1];p.nextTick(()=>{let u=window.getSelection(),m=document.createRange(),c=n[0].childNodes[t.arr.indexOf(d)];c&&(c.nodeType==Node.TEXT_NODE?(m.setStart(c,o),m.setEnd(c,h)):c.nodeType==Node.ELEMENT_NODE&&(c.tagName=="IMG"?m.selectNode(c):(m.setStart(c.firstChild,o),m.setEnd(c.firstChild,h))),u.removeAllRanges(),u.addRange(m))})}}}else if(n.length>1){let t=[];n.forEach(L=>{t.push(a[Array.from(e.value.children).indexOf(L)])});let s=window.getSelection(),r=s.getRangeAt(0),o=r.startOffset,h=r.endOffset,d=r.startContainer,u=r.endContainer,m=[],c=[];if(d.tagName=="DIV")m=[o,0];else{m.unshift(o);let L=d.parentElement;L.tagName=="DIV"?(o=Array.from(L.childNodes).indexOf(d),m.unshift(o)):(o=Array.from(L.parentElement.childNodes).indexOf(L),m.unshift(o))}if(u.tagName=="DIV")c=[h,u.childNodes[h].textContent.length];else{c.unshift(h);let L=u.parentElement;L.tagName=="DIV"?(h=Array.from(L.childNodes).indexOf(u),c.unshift(h)):(h=Array.from(L.parentElement.childNodes).indexOf(L),c.unshift(h))}let f=t[0],y=t[t.length-1],w=f.arr[m[0]],b=y.arr[c[0]],k=w,O=b,P,z;for(let L of t)if(L==f)for(let A=m[0];A<f.arr.length;A++){let C=f.arr[A];if(C.style[l]!=i)if(C==w){let H;if(i)H={value:C.value.substring(m[1]),style:{...C.style,[l]:i},type:E.TEXT};else{let g={...C.style};delete g[l],H={value:C.value.substring(m[1]),style:g,type:E.TEXT}}C.value=C.value.substring(0,m[1]),f.arr.splice(A+1,0,H),A++,k=H,P=0}else i?C.style[l]=i:delete C.style[l];else C==w&&(P=m[1])}else if(L==y)for(let A=0;A<=c[0];A++){let C=y.arr[A];if(C.style[l]!=i)if(C==b){let H;if(i)H={value:C.value.substring(0,c[1]),style:{...C.style,[l]:i},type:E.TEXT};else{let g={...C.style};delete g[l],H={value:C.value.substring(0,c[1]),style:g,type:E.TEXT}}C.value=C.value.substring(c[1]),y.arr.splice(A,0,H),O=H,z=H.value.length}else i?C.style[l]=i:delete C.style[l];else C==b&&(z=c[1])}else L.arr.forEach(A=>{A.style[l]!=i&&(i?A.style[l]=i:delete A.style[l])});let X={startItem:k,startIndex:P},G={endItem:O,endIndex:z};for(let L of t)L==f?T.fixLine(L,X):L==y?T.fixLine(L,G):T.fixLine(L);p.nextTick(()=>{let L=n[0].childNodes[f.arr.indexOf(X.startItem)],A=n[n.length-1].childNodes[y.arr.indexOf(G.endItem)];L.nodeType==Node.TEXT_NODE?r.setStart(L,X.startIndex):L.nodeType==Node.ELEMENT_NODE&&(L.tagName=="IMG"?r.setStartBefore(L):r.setStart(L.firstChild,X.startIndex)),A.nodeType==Node.TEXT_NODE?r.setEnd(A,G.endIndex):A.nodeType==Node.ELEMENT_NODE&&(A.tagName=="IMG"?r.setEndAfter(A):r.setEnd(A.firstChild,G.endIndex)),s.removeAllRanges(),s.addRange(r)})}}function F(x,l,i){let a=[];x.getSelectionItemList().forEach(e=>{a.push(...e.data.filter(n=>n.type===E.TEXT||n.type===E.LINK))});for(let e of a)if(!e.style||e.style[l]!=i)return!1;return!0}class B{static isBold(l){return F(l,"fontWeight","bold")}static bold(l,i){j(l,"fontWeight",i?"bold":void 0)}static isItalic(l){return F(l,"fontStyle","italic")}static italic(l,i){j(l,"fontStyle",i?"italic":void 0)}static isUnderLine(l){return F(l,"textDecoration","underline")}static underLine(l,i){j(l,"textDecoration",i?"underline":void 0)}static isDeleteLine(l){return F(l,"textDecoration","line-through")}static deleteLine(l,i){j(l,"textDecoration",i?"line-through":void 0)}static fontSize(l,i){j(l,"fontSize",i)}static color(l,i){j(l,"color",i)}static backgroundColor(l,i){j(l,"backgroundColor",i)}static link(l,i){U(l,i)}static image(l,i){let a=document.createElement("img");a.src=i,a.onload=()=>{Q(l,i,a.width),a=null}}}let _;function W(x){var i,a,e;let l=(i=window.getSelection())==null?void 0:i.getRangeAt(0);if(x.key==="Backspace"&&_&&l&&((a=_.getRoot().value)!=null&&a.contains(l.commonAncestorContainer))&&_.getSelectElementList().length>0&&!((e=window.getSelection().getRangeAt(0))!=null&&e.collapsed)){x.preventDefault(),x.stopPropagation();let n=_.getSelectionItemList(),t={startItem:null,startIndex:0};if(n.length==1){let s=n[0].line,r=s.arr[s.selectStartIndexPath[0]],o=s.arr[s.selectEndIndexPath[0]];if(r===o){if(r.type===E.TEXT||r.type===E.LINK){let h=r.value.substring(0,s.selectStartIndexPath[1]),d=r.value.substring(s.selectEndIndexPath[1]);r.value=h+d}else s.arr.splice(s.selectStartIndexPath[0],1);t.startItem=r,t.startIndex=s.selectStartIndexPath[1]}else for(let h of n[0].data)h===r?(r.type===E.TEXT||r.type===E.LINK?r.value=r.value.substring(0,s.selectStartIndexPath[1]):s.arr.splice(s.arr.indexOf(r),1),t.startItem=r,t.startIndex=s.selectStartIndexPath[1]):h===o?o.type===E.TEXT||o.type===E.LINK?o.value=o.value.substring(s.selectEndIndexPath[1]):s.arr.splice(s.arr.indexOf(o),1):s.arr.splice(s.arr.indexOf(h),1);T.fixLine(s,t)}else{let s;for(let r=0;r<n.length;r++){let o=n[r],h=o.line;if(r==0||r==n.length-1)if(r==0){s=h;for(let d=0;d<o.data.length;d++){let u=o.data[d];d==0&&(u.type===E.TEXT||u.type===E.LINK)?u.value=u.value.substring(0,h.selectStartIndexPath[1]):h.arr.splice(h.arr.indexOf(u),1)}}else{for(let d=0;d<o.data.length;d++){let u=o.data[d];d==o.data.length-1&&(u.type===E.TEXT||u.type===E.LINK)?u.value=u.value.substring(h.selectEndIndexPath[1]):h.arr.splice(h.arr.indexOf(u),1)}s.arr=s.arr.concat(h.arr),_.getLineList().splice(_.getLineList().indexOf(h),1),T.fixLine(s)}else _.getLineList().splice(_.getLineList().indexOf(h),1)}}p.nextTick(()=>{let s=window.getSelection(),r=document.createRange(),o=_.getLineList().indexOf(n[0].line),h=_.getRoot().value.children[o].childNodes[n[0].line.selectStartIndexPath[0]];if(h){if(h.nodeType===Node.TEXT_NODE||h.tagName==="SPAN"){let d=h.tagName==="SPAN"?h.innerText:h.textContent;n[0].line.selectStartIndexPath[1]>=d.length?(r.setStartAfter(h),r.setEndAfter(h)):(r.setStart(h,n[0].line.selectStartIndexPath[1]),r.setEnd(h,n[0].line.selectStartIndexPath[1]))}else r.setStartAfter(h),r.setEndAfter(h);s.removeAllRanges(),s.addRange(r);for(let d of _.getSelectElementList())d.contentEditable="true";_.setSelectElementList([])}})}}class ${constructor(l,i,a){M(this,"selectElementList",[]);M(this,"isMouseDown",!1);M(this,"root");M(this,"lineList",p.reactive([]));M(this,"imageHelperElement");M(this,"resizeImage");M(this,"resizeObserver");M(this,"selectionMenuElement");M(this,"selectionTextElement");M(this,"selectionLinkElement");M(this,"selectionColorElement");M(this,"linkEditElement");M(this,"popMenuPosition");M(this,"quotePosition");M(this,"destroyFunc");M(this,"destroyQuoteFunc");M(this,"onUploadFileFunc");M(this,"onPopMenuClickFunc");M(this,"onCustomMenuClickFunc");M(this,"onQuoteListFunc");M(this,"onSetLineConfigType");M(this,"onGetLineConfigType");this.root=l,this.popMenuPosition=i,this.quotePosition=a,document.addEventListener("keydown",W)}setSelectElementList(l){this.selectElementList=l}clear(){var l,i,a,e,n,t;(l=this.destroyFunc)==null||l.call(this),(i=this.destroyQuoteFunc)==null||i.call(this),(a=this.imageHelperElement)==null||a.remove(),(e=this.resizeObserver)==null||e.disconnect(),(n=this.selectionMenuElement)==null||n.remove(),(t=this.linkEditElement)==null||t.remove(),this.popMenuPosition.value=null,this.quotePosition.value=null}clearQuote(){this.quotePosition.value=null}getLineList(){return this.lineList}setLineList(l){this.lineList.splice(0,this.lineList.length,...l)}getSelectElementList(){return this.selectElementList}getRoot(){return this.root}addLine(l,i){let a={arr:[{value:l,...i,type:E.TEXT}],selectEndIndexPath:[],selectStartIndexPath:[]};this.lineList.push(a)}onFocus(l,i){_=this,this.selectElementList.length==0&&(this.selectElementList=[i.currentTarget])}onDbClick(l){this.selectElementList=[l.currentTarget]}onBlur(l,i){T.handleInnerHtml(l,i.currentTarget,!0,this.onGetLineConfigType),this.selectionMenuElement&&!this.selectionMenuElement.contains(i.relatedTarget)&&!this.selectionLinkElement.contains(i.relatedTarget)&&(this.selectionMenuElement.style.display="none"),this.imageHelperElement&&(this.imageHelperElement.style.display="none",this.resizeObserver.unobserve(this.imageHelperElement),this.resizeImage=null),this.popMenuPosition.value=null}onEnter(l,i,a){a.preventDefault(),a.stopPropagation(),T.handleInnerHtml(l,a.currentTarget,!1,this.onGetLineConfigType);let e=l.arr[l.selectStartIndexPath[0]],n={arr:l.arr.slice(l.selectStartIndexPath[0]+1),selectStartIndexPath:[],selectEndIndexPath:[]};if(!e||e.type===E.TEXT||e.type===E.LINK){let t=e==null?void 0:e.value.substring(l.selectStartIndexPath[1]);t?(n.arr.unshift({value:t,style:{...e.style},type:E.TEXT}),e.value=e.value.substring(0,l.selectStartIndexPath[1])):n.arr.unshift({value:"",style:{},type:E.TEXT})}l.arr.splice(l.selectStartIndexPath[0]+1),this.lineList.splice(i+1,0,n),p.nextTick(()=>{this.selectElementList=[this.root.value.children[i+1]];let t=this.root.value.children[i+1],s=window.getSelection(),r=document.createRange();r.selectNodeContents(t),r.collapse(!0),s.removeAllRanges(),s.addRange(r)})}onDelete(l,i,a){let e=a.currentTarget,t=window.getSelection().getRangeAt(0),s=t.startOffset,r=t.endOffset,o=t.startContainer,h=o,d=t.endContainer,u=d,m=[],c=[];if(o.tagName=="DIV")m=[0,s];else{m.unshift(s);let f=o.parentElement;f.tagName=="DIV"?(s=Array.from(f.childNodes).indexOf(o),m.unshift(s),o=f):(s=Array.from(f.parentElement.childNodes).indexOf(f),m.unshift(s),o=f.parentElement)}if(d.tagName=="DIV")c=[0,r];else{c.unshift(r);let f=d.parentElement;f.tagName=="DIV"?(r=Array.from(f.childNodes).indexOf(d),c.unshift(r),d=f):(r=Array.from(f.parentElement.childNodes).indexOf(f),c.unshift(r),d=f.parentElement)}if(m[0]==0&&m[1]==0&&c[0]==0&&c[1]==0&&h==u&&l>0){a.preventDefault(),a.stopPropagation(),T.handleInnerHtml(i,e,!1,this.onGetLineConfigType);let f=this.lineList[l-1];i.arr=i.arr.filter(w=>w.value.length>0||w.type===E.IMAGE);let y=[f.arr.length-1>=0?f.arr.length-1:0,f.arr.length>0?f.arr[f.arr.length-1].value.length:0];f.arr=f.arr.concat(i.arr),this.lineList.splice(l,1),T.fixLine(f),p.nextTick(()=>{let w=window.getSelection(),b=document.createRange(),k=this.root.value.children[l-1].childNodes[y[0]];if(k)k.nodeType==Node.TEXT_NODE?(b.setStart(k,y[1]),b.setEnd(k,y[1])):k.nodeType==Node.ELEMENT_NODE&&(k.tagName=="IMG"||k.tagName=="A"?(b.selectNode(k),b.collapse(!1)):(b.setStart(k.firstChild,y[1]),b.setEnd(k.firstChild,y[1])));else{let O=this.root.value.children[l-1];b.selectNodeContents(O),b.collapse(!0)}w.removeAllRanges(),w.addRange(b)})}}onMouseDown(l){this.popMenuPosition.value=null,this.clearQuote(),l.detail==1&&(this.selectElementList=[l.currentTarget],this.isMouseDown=!0)}onMouseMove(l){let i=l.currentTarget;if(this.isMouseDown&&!this.selectElementList.includes(i)){this.selectElementList.push(i);for(let a of this.selectElementList)a.innerHTML!==""&&(a.contentEditable="false")}}onMouseUp(l){this.isMouseDown=!1;let i=window.getSelection();if(i.rangeCount==0)return;let a=i.getRangeAt(0);if(this.selectElementList.length>0){a=a.cloneRange();for(let s of this.selectElementList)p.nextTick(()=>{s.contentEditable="true"});let e=a.startContainer;for(;e.tagName!=="DIV";)e=e.parentElement;let n=a.endContainer;for(;n.tagName!=="DIV";)n=n.parentElement;let t=Array.from(this.root.value.children);this.selectElementList=[];for(let s=t.indexOf(e);s<=t.indexOf(n);s++)this.selectElementList.push(t[s]);i.removeAllRanges(),i.addRange(a),this.handleMenu(l,a)}}onClick(l){var a;let i=l.target;if(i.tagName==="A"||i.parentElement.tagName==="A"){let e;i.tagName==="A"?e=i:i.parentElement.tagName==="A"&&(e=i.parentElement);let n=e.getAttribute("type");n&&((a=this.onCustomMenuClickFunc)==null||a.call(this,Number(n),e.getAttribute("value"),e.getAttribute("link"),e.innerText))}}generatorSelectionMenu(l){let i=l.offsetParent;this.selectionMenuElement=document.createElement("div"),this.selectionMenuElement.tabIndex=-1,this.selectionMenuElement.style.position="absolute",this.selectionMenuElement.style.borderRadius="5px",this.selectionMenuElement.style.boxShadow="0px 0px 2px 2px rgba(169, 169, 169, 0.2)",this.selectionMenuElement.style.backgroundColor="white",this.selectionMenuElement.style.border="1px solid rgba(169, 169, 169, 0.2)";let a=document.createElement("span");a.setAttribute("name","text"),a.style.cursor="pointer",a.style.display="inline-block",a.style.width="50px",a.style.height="30px",a.style.textAlign="center",a.style.lineHeight="30px",a.style.borderRight="1px solid lightgray",a.innerText="Text",a.onmouseenter=()=>{this.selectionTextElement.style.display="block",this.selectionTextElement.style.left=this.selectionMenuElement.offsetLeft+"px",this.selectionTextElement.style.top=this.selectionMenuElement.offsetTop+this.selectionMenuElement.offsetHeight-2+"px"},a.onmouseleave=h=>{let d=h.relatedTarget;(!d||!this.selectionTextElement.contains(d))&&(this.selectionTextElement.style.display="none")},this.selectionMenuElement.appendChild(a);let e=document.createElement("button");e.setAttribute("name","bold"),e.style.cursor="pointer",e.style.width="30px",e.style.height="30px",e.style.textAlign="center",e.style.lineHeight="30px",e.style.fontWeight="bold",e.style.backgroundColor="transparent",e.style.border="0px",e.innerText="B",e.onclick=()=>{B.bold(this,e.style.color=="black"),e.style.color=e.style.color=="black"?"blue":"black"},this.selectionMenuElement.appendChild(e);let n=document.createElement("button");n.setAttribute("name","italic"),n.style.cursor="pointer",n.style.width="30px",n.style.height="30px",n.style.textAlign="center",n.style.lineHeight="30px",n.style.fontStyle="italic",n.style.backgroundColor="transparent",n.style.border="0px",n.innerText="I",n.onclick=()=>{B.italic(this,n.style.color=="black"),n.style.color=n.style.color=="black"?"blue":"black"},this.selectionMenuElement.appendChild(n);let t=document.createElement("button");t.setAttribute("name","underline"),t.style.cursor="pointer",t.style.width="30px",t.style.height="30px",t.style.textAlign="center",t.style.lineHeight="30px",t.style.textDecoration="underline",t.style.backgroundColor="transparent",t.style.border="0px",t.innerText="U",t.onclick=()=>{B.underLine(this,t.style.color=="black"),t.style.color=t.style.color=="black"?"blue":"black"},this.selectionMenuElement.appendChild(t);let s=document.createElement("button");s.setAttribute("name","lineThrough"),s.style.cursor="pointer",s.style.width="30px",s.style.height="30px",s.style.textAlign="center",s.style.lineHeight="30px",s.style.textDecoration="line-through",s.style.backgroundColor="transparent",s.style.border="0px",s.innerText="S",s.onclick=()=>{B.deleteLine(this,s.style.color=="black"),s.style.color=s.style.color=="black"?"blue":"black"},this.selectionMenuElement.appendChild(s);let r=document.createElement("span");r.setAttribute("name","color"),r.style.cursor="pointer",r.style.display="inline-block",r.style.width="30px",r.style.height="30px",r.style.textAlign="center",r.style.lineHeight="30px",r.innerText="A",r.onmouseenter=()=>{this.selectionColorElement.style.display="block",this.selectionColorElement.style.left=this.selectionMenuElement.offsetLeft+r.offsetLeft-100+"px",this.selectionColorElement.style.top=this.selectionMenuElement.offsetTop+this.selectionMenuElement.offsetHeight-2+"px"},r.onmouseleave=h=>{let d=h.relatedTarget;(!d||!this.selectionColorElement.contains(d))&&(this.selectionColorElement.style.display="none")},this.selectionMenuElement.appendChild(r);let o=document.createElement("span");o.setAttribute("name","link"),o.style.cursor="pointer",o.style.display="inline-block",o.style.width="50px",o.style.height="30px",o.style.textAlign="center",o.style.lineHeight="30px",o.innerText="Link",o.onmouseenter=()=>{this.selectionLinkElement.style.display="block",this.selectionLinkElement.style.left=this.selectionMenuElement.offsetLeft+o.offsetLeft-100+"px",this.selectionLinkElement.style.top=this.selectionMenuElement.offsetTop+this.selectionMenuElement.offsetHeight-2+"px",this.selectionLinkElement.querySelector("input").value=""},o.onmouseleave=h=>{let d=h.relatedTarget;(!d||!this.selectionLinkElement.contains(d))&&(this.selectionLinkElement.style.display="none")},this.selectionMenuElement.appendChild(o),i.appendChild(this.selectionMenuElement)}generatorSelectionColor(l){let i=l.offsetParent;this.selectionColorElement=document.createElement("div"),this.selectionColorElement.style.position="absolute",this.selectionColorElement.setAttribute("name","colorList"),this.selectionColorElement.style.display="none",this.selectionColorElement.appendChild(document.createTextNode("Text Color")),this.selectionColorElement.style.borderRadius="5px",this.selectionColorElement.style.boxShadow="0px 0px 2px 2px rgba(169, 169, 169, 0.2)",this.selectionColorElement.style.backgroundColor="white",this.selectionColorElement.style.border="1px solid rgba(169, 169, 169, 0.2)",this.selectionColorElement.style.width="200px",this.selectionColorElement.style.padding="5px",this.selectionColorElement.style.color="gray",this.selectionColorElement.style.fontSize="14px",this.selectionColorElement.onmouseleave=()=>{this.selectionColorElement.style.display="none"};let a=document.createElement("div");a.style.display="flex",a.style.flexWrap="wrap",a.style.marginTop="5px",a.style.marginBottom="10px";let e=["black","red","blue","green","yellow","gray","brown","orange","pink","purple"];for(let s of e){let r=document.createElement("button");r.style.cursor="pointer",r.style.width="25px",r.style.height="25px",r.style.textAlign="center",r.style.lineHeight="25px",r.style.backgroundColor="transparent",r.style.border="1px solid lightgray",r.style.color=s,r.style.marginRight="5px",r.style.marginTop="5px",r.style.borderRadius="5px",r.innerText="A",r.onclick=()=>{B.color(this,s),this.selectionColorElement.style.display="none"},a.appendChild(r)}this.selectionColorElement.appendChild(a),this.selectionColorElement.appendChild(document.createTextNode("Background Color"));let n=document.createElement("div");n.style.display="flex",n.style.flexWrap="wrap",n.style.marginTop="5px";let t=["transparent","red","blue","green","yellow","gray","brown","orange","pink","purple"];for(let s of t){let r=document.createElement("button");r.style.cursor="pointer",r.style.width="25px",r.style.height="25px",r.style.marginRight="5px",r.style.marginTop="5px",r.style.border="0px",r.style.borderRadius="5px",s!="transparent"&&(r.style.backgroundColor=s),r.onclick=()=>{B.backgroundColor(this,s),this.selectionColorElement.style.display="none"},n.appendChild(r)}this.selectionColorElement.appendChild(n),i.appendChild(this.selectionColorElement)}generatorSelectionText(l){let i=l.offsetParent;this.selectionTextElement=document.createElement("div"),this.selectionTextElement.setAttribute("name","fontSizeList"),this.selectionTextElement.style.display="none",this.selectionTextElement.style.flexDirection="column",this.selectionTextElement.style.width="60px",this.selectionTextElement.style.position="absolute",this.selectionTextElement.style.borderRadius="5px",this.selectionTextElement.style.boxShadow="0px 0px 2px 2px rgba(169, 169, 169, 0.2)",this.selectionTextElement.style.backgroundColor="white",this.selectionTextElement.style.border="1px solid rgba(169, 169, 169, 0.2)",this.selectionTextElement.onmouseleave=()=>{this.selectionTextElement.style.display="none"};for(let a=16;a<=48;a+=8){let e=document.createElement("button");e.style.cursor="pointer",e.style.width="100%",e.style.height="30px",e.style.textAlign="center",e.style.lineHeight="30px",e.style.backgroundColor="transparent",e.style.border="0px",a==16?e.innerText="Normal":a==24?e.innerText="H4":a==32?e.innerText="H3":a==40?e.innerText="H2":a==48&&(e.innerText="H1"),e.onclick=()=>{B.fontSize(this,String(a)+"px"),this.selectionTextElement.style.display="none"},this.selectionTextElement.appendChild(e)}i.appendChild(this.selectionTextElement)}generatorSelectionLink(l){let i=l.offsetParent;this.selectionLinkElement=document.createElement("div"),this.selectionLinkElement.setAttribute("name","link"),this.selectionLinkElement.style.display="none",this.selectionLinkElement.style.position="absolute",this.selectionLinkElement.style.borderRadius="5px",this.selectionLinkElement.style.boxShadow="0px 0px 2px 2px rgba(169, 169, 169, 0.2)",this.selectionLinkElement.style.backgroundColor="white",this.selectionLinkElement.style.border="1px solid rgba(169, 169, 169, 0.2)",this.selectionLinkElement.style.padding="5px",this.selectionLinkElement.onmouseleave=()=>{this.selectionLinkElement.style.display="none"};let a=document.createElement("input");a.placeholder="type your link";let e=document.createElement("button");e.innerText="save",e.style.backgroundColor="transparent",e.style.border="0px",e.style.marginLeft="10px",e.onclick=()=>{a.value&&(B.link(this,a.value),this.selectionLinkElement.style.display="none")},this.selectionLinkElement.appendChild(a),this.selectionLinkElement.appendChild(e),i.appendChild(this.selectionLinkElement)}generatorLinkEdit(l){let i=l.offsetParent;this.linkEditElement=document.createElement("div"),this.linkEditElement.setAttribute("name","linkEdit"),this.linkEditElement.style.display="none",this.linkEditElement.style.position="absolute",this.linkEditElement.style.borderRadius="5px",this.linkEditElement.style.boxShadow="0px 0px 2px 2px rgba(169, 169, 169, 0.2)",this.linkEditElement.style.backgroundColor="white",this.linkEditElement.style.border="1px solid rgba(169, 169, 169, 0.2)",this.linkEditElement.style.padding="5px",this.linkEditElement.style.color="gray",this.linkEditElement.style.fontSize="14px",this.linkEditElement.onmouseleave=()=>{this.linkEditElement.style.display="none"},this.linkEditElement.appendChild(document.createTextNode("uri")),this.linkEditElement.appendChild(document.createElement("br"));let a=document.createElement("input");a.style.marginTop="5px",a.style.marginBottom="10px",a.style.width="90%",a.placeholder="type your link",this.linkEditElement.appendChild(a),this.linkEditElement.appendChild(document.createElement("br")),this.linkEditElement.appendChild(document.createTextNode("title")),this.linkEditElement.appendChild(document.createElement("br"));let e=document.createElement("input");e.placeholder="type your title",e.style.marginTop="5px",e.style.width="90%",this.linkEditElement.appendChild(e);let n=document.createElement("button");n.setAttribute("name","save"),n.innerText="save",n.style.borderRadius="5px",n.style.border="0px",n.style.marginTop="10px",n.style.width="100%",n.style.height="25px",this.linkEditElement.appendChild(n),this.linkEditElement.appendChild(document.createElement("br"));let t=document.createElement("button");t.setAttribute("name","remove"),t.innerText="remove",t.style.borderRadius="5px",t.style.border="0px",t.style.marginTop="10px",t.style.width="100%",t.style.height="25px",this.linkEditElement.appendChild(t),i.appendChild(this.linkEditElement)}handleMenu(l,i){if(i.collapsed){this.selectionMenuElement&&(this.selectionMenuElement.style.display="none");let a=l.target;if(a.tagName=="A"&&a.getAttribute("target")){this.linkEditElement||this.generatorLinkEdit(a);let e=a.parentElement,n=Array.from(e.childNodes).indexOf(a),t=Array.from(this.root.value.children).indexOf(e),s=this.lineList[t].arr[n];this.linkEditElement.style.display="block";let r=i.getBoundingClientRect(),h=l.target.offsetParent.getBoundingClientRect(),d=r.left-h.left;r.top-h.top;let u=r.bottom-h.top,m=d-10,c=u+10;m<0&&(m=0),this.linkEditElement.style.left=m+"px",this.linkEditElement.style.top=c+"px";let f=this.linkEditElement.querySelectorAll("input")[0];f.value=s.link;let y=this.linkEditElement.querySelectorAll("input")[1];y.value=s.value;let w=this.linkEditElement.querySelector("[name='save']");w.onclick=()=>{let k=this.lineList[t].arr[n],O=f.value,P=y.value;!O||!P||(k.link=O,k.value=P,this.linkEditElement.style.display="none")};let b=this.linkEditElement.querySelector("[name='remove']");b.onclick=()=>{let k=this.lineList[t].arr[n];k.type=E.TEXT,delete k.link,T.fixLine(this.lineList[t]),this.linkEditElement.style.display="none"}}}else{if(!this.selectionMenuElement){let y=l.target;this.generatorSelectionMenu(y),this.generatorSelectionText(y),this.generatorSelectionColor(y),this.generatorSelectionLink(y)}this.selectionMenuElement.style.display="block";let a=i.getBoundingClientRect(),n=l.target.offsetParent.getBoundingClientRect(),t=a.left-n.left,s=a.top-n.top,r=a.bottom-n.top,o=t-10,h=s-40;o<0&&(o=t),h<0&&(h=r+10),this.selectionMenuElement.style.left=o+"px",this.selectionMenuElement.style.top=h+"px";let d=B.isBold(this),u=B.isItalic(this),m=B.isUnderLine(this),c=B.isDeleteLine(this),f=this.selectionMenuElement.querySelector("[name='bold']");f.style.color=d?"blue":"black",f=this.selectionMenuElement.querySelector("[name='italic']"),f.style.color=u?"blue":"black",f=this.selectionMenuElement.querySelector("[name='underline']"),f.style.color=m?"blue":"black",f=this.selectionMenuElement.querySelector("[name='lineThrough']"),f.style.color=c?"blue":"black"}}onCopy(l){const i=window.getSelection().getRangeAt(0);i.startContainer.nodeType===Node.TEXT_NODE&&i.startContainer.parentElement.tagName==="A"&&i.setStartBefore(i.startContainer.parentElement);const a=i.cloneContents(),e=document.createElement("div");e.setAttribute("copy","teamlinker"),e.appendChild(a),l.clipboardData.setData("text/html",e.outerHTML),l.clipboardData.setData("text/plain",e.innerText),l.preventDefault(),l.stopPropagation()}onPaste(l){var a;let i=l.clipboardData.types;if(this.getSelectElementList(),i.includes("Files")){let e=l.clipboardData.files[0];if(e){let n=window.getSelection(),s=n.getRangeAt(0).startContainer;for(;s.tagName!="DIV";)s=s.parentElement;let r=Array.from(this.root.value.children).indexOf(s),o=this.lineList[r];T.handleInnerHtml(o,s,!0,this.onGetLineConfigType),(a=this.onUploadFileFunc)==null||a.call(this,e,(h,d)=>{let u=o.arr[o.selectStartIndexPath[0]],m={value:h,link:d,type:E.IMAGE},c;if(u){let f=JSON.parse(JSON.stringify(u));f.value=f.value.substring(o.selectStartIndexPath[1]);let y=[...o.arr.slice(o.selectStartIndexPath[0]+1)];f.type!=E.IMAGE&&y.unshift(f),u.value=u.value.substring(0,o.selectStartIndexPath[1]),o.arr.splice(o.selectStartIndexPath[0]+1,0,m),c=o.arr.length-1,o.arr=o.arr.concat(y)}else o.arr=[m],c=0;T.fixLine(o),p.nextTick(()=>{let f=document.createRange();f.selectNode(s.childNodes[c]),f.collapse(!1),n.removeAllRanges(),n.addRange(f)})})}}else if(i!=null&&i.includes("text/html")){l.stopPropagation(),l.preventDefault();let e=document.createElement("div");e.innerHTML=l.clipboardData.getData("text/html");let n=e.getElementsByTagName("div"),t=!1;e.childNodes.length==2&&e.firstChild.tagName==="META"&&e.childNodes[1].tagName==="DIV"&&e.childNodes[1].getAttribute("copy")==="teamlinker"&&(t=!0);let s=window.getSelection(),o=s.getRangeAt(0).startContainer;for(;o.tagName!="DIV";)o=o.parentElement;let h=Array.from(this.root.value.children).indexOf(o),d=this.lineList[Array.from(this.root.value.children).indexOf(o)];if(T.handleInnerHtml(d,o,!0,this.onGetLineConfigType),t){let u,m=[];for(let c=0;c<n.length;c++){let f={arr:[],selectEndIndexPath:[],selectStartIndexPath:[]};if(T.handleInnerHtml(f,n[c],!1,this.onGetLineConfigType),c==0||c==n.length-1)if(c==0){let y="",w=!1;if(d.arr.forEach(b=>{y+=b.value,b.type==E.IMAGE&&(w=!0)}),!y&&!w)this.lineList.splice(this.lineList.indexOf(d),1,f);else{let b=d.arr[d.selectStartIndexPath[0]],k=JSON.parse(JSON.stringify(b));k.value=k.value.substring(d.selectStartIndexPath[1]),u=[...d.arr.slice(d.selectStartIndexPath[0]+1)],k.type!=E.IMAGE&&u.unshift(k),b.value=b.value.substring(0,d.selectStartIndexPath[1]),d.arr.splice(d.selectStartIndexPath[0]+1,d.arr.length,...f.arr),T.fixLine(d)}if(n.length==1){let b;u&&(b={endItem:d.arr[d.arr.length-1]},d.arr=d.arr.concat(u),T.fixLine(d,b)),m=[h+c,b?d.arr.indexOf(b.endItem):f.arr.length-1]}}else{let y;u&&(y={endItem:f.arr[f.arr.length-1]},f.arr=f.arr.concat(u),T.fixLine(f,y)),this.lineList.splice(h+c,0,f),m=[h+c,y?f.arr.indexOf(y.endItem):f.arr.length-1]}else this.lineList.splice(h+c,0,f)}p.nextTick(()=>{let c=window.getSelection(),f=document.createRange();f.selectNode(this.root.value.children[m[0]].childNodes[m[1]]),f.collapse(!1),c.removeAllRanges(),c.addRange(f)})}else{let u=d.arr[d.selectStartIndexPath[0]];if(u){let m=(u.value.substring(0,d.selectStartIndexPath[1])+e.innerText).length;u.value=u.value.substring(0,d.selectStartIndexPath[1])+e.innerText+u.value.substring(d.selectStartIndexPath[1]),p.nextTick(()=>{let c=o.childNodes[d.selectStartIndexPath[0]],f=document.createRange();c.nodeType==Node.TEXT_NODE?(f.setStart(c,m),f.setEnd(c,m)):c.nodeType==Node.ELEMENT_NODE&&(c.tagName=="IMG"?(f.selectNode(c),f.collapse(!1)):(f.setStart(c.firstChild,m),f.setEnd(c.firstChild,m))),s.removeAllRanges(),s.addRange(f)})}else d.arr.push({value:e.innerText,type:E.TEXT,style:{}}),p.nextTick(()=>{let m=o.firstChild,c=document.createRange();c.selectNodeContents(m),c.collapse(!1),s.removeAllRanges(),s.addRange(c)})}}}onMouseOver(l){let i=l.target;if(i.tagName=="IMG"){let a=i.offsetParent,e=a.getBoundingClientRect(),n=i.getBoundingClientRect(),t=n.left-e.left,s=n.top-e.top,r=i.offsetWidth,o=i.offsetHeight;this.imageHelperElement||(this.imageHelperElement=document.createElement("div"),a.appendChild(this.imageHelperElement),this.resizeObserver=new ResizeObserver((h,d)=>{for(let u of h)this.resizeImage&&(this.resizeImage.width=u.contentRect.width)})),this.imageHelperElement.style.border="1px solid blue",this.imageHelperElement.style.position="absolute",this.imageHelperElement.style.left=t+"px",this.imageHelperElement.style.top=s+"px",this.imageHelperElement.style.width=r+"px",this.imageHelperElement.style.height=o+"px",this.imageHelperElement.style.overflow="hidden",this.imageHelperElement.style.resize="both",this.imageHelperElement.style.display="block",this.resizeImage=i,this.resizeObserver.observe(this.imageHelperElement)}else this.imageHelperElement&&(this.imageHelperElement.style.display="none",this.resizeObserver.unobserve(this.imageHelperElement)),this.resizeImage&&(this.resizeImage=null)}onKeyDown(l){if((l.metaKey||l.ctrlKey)&&l.key=="a"){l.stopPropagation(),l.preventDefault();let i=window.getSelection(),e=i.getRangeAt(0).startContainer;for(;e.tagName!="DIV";)e=e.parentElement;let n=Array.from(this.root.value.children).indexOf(e),t=this.lineList[n];T.handleInnerHtml(t,e,!1,this.onGetLineConfigType),this.selectElementList=Array.from(this.root.value.children),p.nextTick(()=>{let s=document.createRange(),r,o;for(let h=0;h<this.root.value.childNodes.length;h++){let d=this.root.value.childNodes[h];for(let u=0;u<d.childNodes.length;u++){let m=d.childNodes[u];if(m){r=m;break}}if(r)break}for(let h=this.root.value.childNodes.length-1;h>=0;h--){let d=this.root.value.childNodes[h];for(let u=d.childNodes.length-1;u>=0;u--){let m=d.childNodes[u];if(m){o=m;break}}if(o)break}r&&o&&(s.setStartBefore(r),s.setEndAfter(o),i.removeAllRanges(),i.addRange(s))})}if(l.key==="/"){let a=window.getSelection().getRangeAt(0),e=a.getBoundingClientRect();if(e.left==0&&e.top==0&&e.width==0&&e.height==0){if(a.startContainer.tagName=="DIV"&&a.startOffset!==0)return;e=a.startContainer.getBoundingClientRect()}let n=e.right+e.width,t=e.bottom,s,r;n>160?s=e.left:s=e.left-150,document.body.clientHeight-t>210?r=e.top+e.height:r=e.top-200,this.popMenuPosition.value={left:s,top:r}}else this.popMenuPosition.value=null;if(l.key==="@"){if(!this.onQuoteListFunc)return;let a=window.getSelection().getRangeAt(0),e=a.getBoundingClientRect();if(e.left==0&&e.top==0&&e.width==0&&e.height==0){if(a.startContainer.tagName=="DIV"&&a.startOffset!==0)return;e=a.startContainer.getBoundingClientRect()}let n=e.right+e.width,t=e.bottom,s,r;n>160?s=e.left:s=e.left-150,document.body.clientHeight-t>210?r=e.top+e.height:r=e.top-200,this.quotePosition.value={left:s,top:r}}else this.clearQuote();if(l.key=="ArrowDown"){let i=window.getSelection(),a=i.getRangeAt(0),e=a.startOffset,n=a.startContainer,t=[];t.unshift(e);let s=n.parentElement;if(n.tagName=="DIV"?t.unshift(0):s.tagName=="DIV"?(e=Array.from(s.childNodes).indexOf(n),t.unshift(e),n=s):(e=Array.from(s.parentElement.childNodes).indexOf(s),t.unshift(e),n=s.parentElement),a.collapsed&&(n.childNodes.length==0||t[0]==n.childNodes.length-1&&t[1]==n.lastChild.textContent.length)){l.stopPropagation(),l.preventDefault();let r=Array.from(this.root.value.children).indexOf(n);if(r<this.lineList.length-1){let o=document.createRange();o.selectNodeContents(this.root.value.children[r+1]),o.collapse(!0),i.removeAllRanges(),i.addRange(o)}}}else if(l.key=="ArrowUp"){let i=window.getSelection(),a=i.getRangeAt(0),e=a.startOffset,n=a.startContainer,t=[];if(t.unshift(e),n.tagName=="DIV")t.unshift(0);else{let s=n.parentElement;s.tagName=="DIV"?(e=Array.from(s.childNodes).indexOf(n),t.unshift(e),n=s):(e=Array.from(s.parentElement.childNodes).indexOf(s),t.unshift(e),n=s.parentElement)}if(a.collapsed&&t[0]==0&&t[1]==0){l.stopPropagation(),l.preventDefault();let s=Array.from(this.root.value.children).indexOf(n);if(s>0){let r=document.createRange();r.selectNodeContents(this.root.value.children[s-1]),r.collapse(!1),i.removeAllRanges(),i.addRange(r)}}}}getSelectionItemList(){let l=[];this.selectElementList.forEach(m=>{l.push(this.lineList[Array.from(this.root.value.children).indexOf(m)])});let a=window.getSelection().getRangeAt(0),e=a.startOffset,n=a.endOffset,t=a.startContainer,s=a.endContainer,r=[],o=[];if(t.tagName=="DIV")r=[e,0];else{r.unshift(e);let m=t.parentElement;m.tagName=="DIV"?(e=Array.from(m.childNodes).indexOf(t),r.unshift(e),t=m):(e=Array.from(m.parentElement.childNodes).indexOf(m),r.unshift(e),t=m.parentElement)}if(s.tagName=="DIV")o=[n,s.childNodes[n]?s.childNodes[n].textContent.length:0];else{o.unshift(n);let m=s.parentElement;m.tagName=="DIV"?(n=Array.from(m.childNodes).indexOf(s),o.unshift(n),s=m):(n=Array.from(m.parentElement.childNodes).indexOf(m),o.unshift(n),s=m.parentElement)}let h=l[0];h.selectStartIndexPath=r;let d=l[l.length-1];d.selectEndIndexPath=o;let u=[];if(l.length==1)T.handleInnerHtml(l[0],t,!1,this.onGetLineConfigType),u=[{line:l[0],data:[...l[0].arr.slice(r[0],o[0]+1)]}];else for(let m of l){let c=u.find(f=>f.line===m);if(c||(c={line:m,data:[]},u.push(c)),m==h){T.handleInnerHtml(m,t,!1,this.onGetLineConfigType);for(let f=r[0];f<h.arr.length;f++){let y=h.arr[f];c.data.push(y)}}else if(m==d){T.handleInnerHtml(m,s,!1,this.onGetLineConfigType);for(let f=0;f<=o[0];f++){let y=d.arr[f];y&&c.data.push(y)}}else T.handleInnerHtml(m,this.root.value.children[this.lineList.indexOf(m)],!1,this.onGetLineConfigType),m.arr.forEach(f=>{c.data.push(f)})}return u}getCurrentInfo(){let a=window.getSelection().getRangeAt(0).startContainer,e=a;for(;e.tagName!="DIV";)e=e.parentElement;let n=Array.from(this.root.value.children).indexOf(e),t=this.lineList[n],s,r;return a!=e&&(r=Array.from(e.childNodes).indexOf(a),s=t.arr[r]),{element:e,line:t,lineIndex:n,item:s,itemIndex:r}}}const Y={style:{position:"absolute",boxShadow:"0px 0px 2px 2px rgba(169, 169, 169, 0.2)",backgroundColor:"white",border:"1px solid rgba(169, 169, 169, 0.2)",width:"150px",height:"200px",overflow:"auto",outlineWidth:"0","z-index":"10000"},tabIndex:"-1"},Z=["onMousedown"],ee=p.defineComponent({__name:"popMenu",props:{objEditor:{},popMenuList:{}},setup(x){const l=x,i=p.ref(l.popMenuList??[]),a=async e=>{var s,r;let n=l.objEditor.getSelectionItemList(),t=JSON.parse(JSON.stringify(n[0].line.selectStartIndexPath));(r=(s=l.objEditor).onPopMenuClickFunc)==null||r.call(s,e.type,o=>{let h=n[0].line,d=l.objEditor.getRoot().value.children[l.objEditor.getLineList().indexOf(h)],u=h.arr[t[0]],m=JSON.parse(JSON.stringify(u));m.value=u.value.substring(t[1]),u.value=u.value.substring(0,t[1]-1),h.arr.splice(t[0]+1,0,o,m);let c={startIndex:t[0]+1};T.fixLine(h,c),p.nextTick(()=>{let f=window.getSelection(),y=document.createRange();y.setStartAfter(d.childNodes[c.startIndex]??d.lastChild),y.setEndAfter(d.childNodes[c.startIndex]??d.lastChild),f.removeAllRanges(),f.addRange(y)})})};return(e,n)=>(p.openBlock(),p.createElementBlock("div",Y,[(p.openBlock(!0),p.createElementBlock(p.Fragment,null,p.renderList(i.value,(t,s)=>(p.openBlock(),p.createElementBlock("div",{class:"item",style:p.normalizeStyle([{height:"35px",display:"flex","align-items":"center","justify-content":"center",cursor:"pointer"},{borderBottom:s!==i.value.length-1?"rgb(241,241,241) 1px solid":""}]),key:t.type,onMousedown:r=>a(t)},p.toDisplayString(t.title),45,Z))),128))]))}}),me="",K=(x,l)=>{const i=x.__vccOpts||x;for(const[a,e]of l)i[a]=e;return i},te=K(ee,[["__scopeId","data-v-5cf468f7"]]),le=["onClick"],ne={style:{height:"30px","border-bottom":"1px lightgray solid"}},ie=["onClick"],se=["src"],re=p.defineComponent({__name:"quote",props:{objEditor:{},quoteType:{},position:{}},setup(x){const l=x,i=p.ref(""),a=p.ref(),e=p.ref([]);let n,t;const s=async()=>{var d,u;(u=(d=l.objEditor).onQuoteListFunc)==null||u.call(d,i.value,m=>{e.value=m})},r=d=>{l.objEditor.clearQuote()},o=d=>{n||(n=l.objEditor.getSelectionItemList(),t=JSON.parse(JSON.stringify(n[0].line.selectStartIndexPath)))},h=async d=>{l.objEditor.clearQuote();let u=n[0].line,m=l.objEditor.getRoot().value.children[l.objEditor.getLineList().indexOf(u)],c=u.arr[t[0]],f=JSON.parse(JSON.stringify(c));f.value=c.value.substring(t[1]),c.value=c.value.substring(0,t[1]-1);let y={type:l.quoteType,value:d.value,label:d.label};u.arr.splice(t[0]+1,0,y,f);let w={startIndex:t[0]+1};T.fixLine(u,w),p.nextTick(()=>{let b=window.getSelection(),k=document.createRange();k.setStartAfter(m.childNodes[w.startIndex]??m.lastChild),k.setEndAfter(m.childNodes[w.startIndex]??m.lastChild),b.removeAllRanges(),b.addRange(k)})};return p.onBeforeMount(()=>{s()}),(d,u)=>(p.openBlock(),p.createElementBlock("div",{style:{width:"100%",height:"100%",position:"absolute","z-index":"10000",left:"0px",top:"0px"},onClick:p.withModifiers(r,["self"])},[p.createElementVNode("div",{style:p.normalizeStyle([{width:"150px",height:"200px",padding:"5px","box-sizing":"border-box",position:"absolute","box-shadow":"0px 0px 2px 2px rgba(169, 169, 169, 0.2)",border:"1px solid rgba(169, 169, 169, 0.2)","background-color":"white",overflow:"auto","outline-width":"0"},{left:d.position.left+"px",top:d.position.top+"px"}]),ref_key:"rootEle",ref:a,onMousedown:o},[p.createElementVNode("div",ne,[p.withDirectives(p.createElementVNode("input",{"onUpdate:modelValue":u[0]||(u[0]=m=>i.value=m),style:{width:"100%","box-sizing":"border-box"},onInput:s},null,544),[[p.vModelText,i.value]])]),(p.openBlock(!0),p.createElementBlock(p.Fragment,null,p.renderList(e.value,m=>(p.openBlock(),p.createElementBlock("div",{class:"hover",style:{height:"40px",display:"flex","align-items":"center"},onClick:c=>h(m)},[m.photo?(p.openBlock(),p.createElementBlock("img",{key:0,style:{width:"30px",height:"30px","border-radius":"15px"},src:m.photo},null,8,se)):p.createCommentVNode("",!0),p.createTextVNode("Â  "+p.toDisplayString(m.label),1)],8,ie))),256))],36)],8,le))}}),ue="",oe=K(re,[["__scopeId","data-v-d7f26c8d"]]),ae=["onBlur","innerHTML","onKeydown","onFocus","placeholder"],de=["innerHTML"],ce=p.defineComponent({__name:"index",props:{readonly:{type:Boolean},modelValue:{},border:{type:Boolean},popMenuList:{},placeholder:{},quoteType:{}},emits:["update:modelValue","uploadFile","popMenuClick","customAnchorClick","quoteList","metaEnter","linkClick","setLineConfigType","getLineConfigType"],setup(x,{expose:l,emit:i}){const a=x,e=p.ref(),n=p.ref([]);let t=[0,0,0];const s=p.ref(),r=p.ref(),o=new $(e,s,r);o.onSetLineConfigType=(g,I)=>{i("setLineConfigType",g,I)},o.onGetLineConfigType=(g,I)=>{i("getLineConfigType",g,I)},o.onUploadFileFunc=(g,I)=>{i("uploadFile",g,I)},o.onPopMenuClickFunc=(g,I)=>{i("popMenuClick",g,I)},o.onCustomMenuClickFunc=(g,I,S,N)=>{i("customAnchorClick",g,I,S,N)},p.getCurrentInstance().vnode.props.onQuoteList&&(o.onQuoteListFunc=(g,I)=>{i("quoteList",g,I)});const h=o.getLineList();let d=[],u=!1;p.watch(h,()=>{i("update:modelValue",h)},{deep:!0}),p.watch(()=>a.modelValue,(g,I,S)=>{if(o.setLineList(a.modelValue),h.length==0&&o.addLine(""),I&&I.length>0&&!u){let N=JSON.parse(JSON.stringify(I));N.forEach(R=>{delete R.selectStartIndexPath,delete R.selectEndIndexPath});let v=JSON.stringify(N);if(d.length==0)d.unshift(N);else{let R=d[0];JSON.stringify(R)!==v&&d.unshift(N)}d.length>10&&d.pop()}else u===!0&&(u=!1)},{deep:!0,immediate:!0});const m=(g,I)=>{o.onFocus(g,I)},c=g=>{o.onDbClick(g)},f=(g,I)=>{o.onBlur(g,I)},y=(g,I,S)=>{S.metaKey?(T.handleInnerHtml(g,S.currentTarget,!1,o.onGetLineConfigType),p.nextTick(()=>{i("metaEnter")})):o.onEnter(g,I,S)},w=(g,I,S)=>{o.onDelete(g,I,S)},b=g=>{o.onMouseDown(g)},k=g=>{o.onMouseMove(g)},O=()=>{let g=window.getSelection();if(g.rangeCount==0)return;let I=g.getRangeAt(0),S=I.startOffset;t=[];let N=I.startContainer;if(N.tagName==="DIV")t=[0,S],t.unshift(Array.from(N.parentElement.children).indexOf(N));else{t=[S];let v=N.parentElement;v.tagName=="DIV"?(S=Array.from(v.childNodes).indexOf(N),t.unshift(S),N=v):(S=Array.from(v.parentElement.childNodes).indexOf(v),t.unshift(S),N=v.parentElement),t.unshift(Array.from(N.parentElement.children).indexOf(N))}},P=g=>{O()},z=g=>{o.onMouseUp(g),O()},X=g=>{o.onPaste(g)},G=g=>{a.readonly||o.onMouseOver(g)},L=g=>{o.onCopy(g)},A=g=>{if(!a.readonly&&(o.onKeyDown(g),g.key=="z"&&(g.metaKey||g.ctrlKey))){if(g.stopPropagation(),g.preventDefault(),d.length>0){let I=d.shift();o.setLineList(I)}u=!0}},C=g=>{if(o.onClick(g),a.readonly){let I=g.target,S=I.getAttribute("type");if(I.tagName==="A"&&S){let N=I.getAttribute("value");i("linkClick",Number(S),N,g.x,g.y)}}},H=g=>{if(g.length==0)return;let I=[];g.forEach(V=>{I.push(V,{type:E.TEXT,value:"&nbsp;"})});let S=h[t[0]],N=n.value[t[0]];T.handleInnerHtml(S,N,!1,o.onGetLineConfigType);let v=S.arr[t[1]],R;if(v){let V=JSON.parse(JSON.stringify(v));V.value=v.value.substring(t[2]),v.value=v.value.substring(0,t[2]),S.arr.splice(t[1]+1,0,...I,V),R={endIndex:t[1]+I.length}}else S.arr.push(...I),R={endIndex:t[1]+I.length-1};T.fixLine(S,R),p.nextTick(()=>{let V=window.getSelection(),q=document.createRange();q.setStart(N.childNodes[R.endIndex],1),q.setEnd(N.childNodes[R.endIndex],1),V.removeAllRanges(),V.addRange(q)})};return p.onBeforeUnmount(()=>{o.clear()}),l({insertConfig:H}),(g,I)=>{var S;return p.openBlock(),p.createElementBlock(p.Fragment,null,[p.createElementVNode("div",p.mergeProps({ref_key:"root",ref:e,onMouseover:G,onKeydown:A,style:[{padding:"10px"},{border:g.border?"border: 1px solid lightgray;":"0px"}],onKeyup:P,onCopy:L},g.$attrs),[g.readonly?(p.openBlock(!0),p.createElementBlock(p.Fragment,{key:1},p.renderList(p.unref(h),(N,v)=>(p.openBlock(),p.createElementBlock("div",{onClick:C,key:v+1,innerHTML:p.unref(T).handle(N,p.unref(o).onSetLineConfigType),style:{"line-height":"1.5","min-height":"21px"}},null,8,de))),128)):(p.openBlock(!0),p.createElementBlock(p.Fragment,{key:0},p.renderList(p.unref(h),(N,v)=>(p.openBlock(),p.createElementBlock("div",{key:v,contenteditable:"true",onBlur:R=>f(N,R),ref_for:!0,ref_key:"elementList",ref:n,innerHTML:p.unref(T).handle(N,p.unref(o).onSetLineConfigType),onKeydown:[p.withKeys(R=>y(N,v,R),["enter"]),p.withKeys(R=>w(v,N,R),["delete"])],style:{"line-height":"1.5"},onFocus:R=>m(N,R),onMousedown:b,onMouseup:z,onMousemove:k,onDblclick:c,onPaste:X,onClick:C,placeholder:g.placeholder??"type something"},null,40,ae))),128))],16),s.value&&((S=g.popMenuList)==null?void 0:S.length)>0?(p.openBlock(),p.createBlock(p.Teleport,{key:0,to:"body"},[p.createVNode(te,{"obj-editor":p.unref(o),"pop-menu-list":g.popMenuList,style:p.normalizeStyle({left:s.value.left+"px",top:s.value.top+"px"})},null,8,["obj-editor","pop-menu-list","style"])])):p.createCommentVNode("",!0),r.value&&g.quoteType!=null?(p.openBlock(),p.createBlock(p.Teleport,{key:1,to:"body"},[p.createVNode(oe,{"obj-editor":p.unref(o),"quote-type":g.quoteType,position:r.value},null,8,["obj-editor","quote-type","position"])])):p.createCommentVNode("",!0)],64)}}}),ge="",J=K(ce,[["__scopeId","data-v-81822f8b"]]),he={install(x){x.component("TLEditor",J)}};D.Editor=J,D.default=he,Object.defineProperties(D,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
